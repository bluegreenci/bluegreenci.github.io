---
import {
  getCombinedReadingTime,
  getSubpostCount,
  isSubpost,
  parseAuthors,
} from '@/lib/data-utils'
import { formatDate } from '@/lib/utils'
import { getTagVariant } from '@/lib/utils'
import { Icon } from 'astro-icon/components'
import type { CollectionEntry } from 'astro:content'
import Link from './Link.astro'

interface Props {
  entry: CollectionEntry<'blog'>
}

const { entry } = Astro.props
const formattedDate = formatDate(entry.data.date)
const readTime = await getCombinedReadingTime(entry.id)
const authors = await parseAuthors(entry.data.authors ?? [])
const subpostCount = !isSubpost(entry.id) ? await getSubpostCount(entry.id) : 0
---

<Link
  href={`/${entry.id}`}
  class="group flex h-full flex-col gap-4 rounded-[18px] px-5 py-4 text-left transition-all duration-300 hover:translate-x-0.5"
>
  <div class="flex flex-col gap-3">
    <div class="flex items-center gap-2 text-[11px] font-semibold uppercase tracking-[0.35em] text-slate-500/80 dark:text-slate-400/80">
      <span>{formattedDate}</span>
      <span class="h-px flex-1 rounded-full bg-gradient-to-r from-emerald-500/40 via-sky-500/40 to-blue-600/40 dark:from-emerald-500/30 dark:via-sky-500/30 dark:to-blue-600/30" aria-hidden="true"></span>
    </div>
    <div class="flex items-start justify-between gap-4">
      <div class="space-y-2">
        <h3 class="text-lg font-semibold leading-snug text-slate-900 transition-colors group-hover:text-blue-600 dark:text-white dark:group-hover:text-emerald-400">
          {entry.data.title}
        </h3>
        <p class="text-sm text-slate-600 dark:text-slate-300 line-clamp-2">
          {entry.data.description}
        </p>
      </div>
      <span class="inline-flex size-10 flex-shrink-0 items-center justify-center rounded-full border border-white/60 bg-white/80 text-blue-600 shadow-sm transition-all duration-300 group-hover:-translate-y-0.5 group-hover:text-emerald-500 dark:border-white/10 dark:bg-white/10 dark:text-emerald-400">
        <Icon name="lucide:arrow-up-right" class="size-4" />
      </span>
    </div>
  </div>

  <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500 dark:text-slate-300">
    {authors.length > 0 && (
      <span class="text-sm font-medium text-slate-700 dark:text-white">
        {authors.map((a) => a.name).join(', ')}
      </span>
    )}
    {authors.length > 0 && (
      <span class="h-1 w-1 rounded-full bg-slate-300/70 dark:bg-white/30" aria-hidden="true"></span>
    )}
    <span class="inline-flex items-center gap-1 rounded-full bg-blue-50/80 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-blue-600 dark:bg-white/10 dark:text-sky-400">
      <Icon name="lucide:clock" class="size-3" />
      {readTime}
    </span>
    {
      subpostCount > 0 && (
        <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50/80 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-emerald-700 dark:bg-white/10 dark:text-emerald-200">
          <Icon name="lucide:layers" class="size-3" />
          {subpostCount} parts
        </span>
      )
    }
  </div>

  {
    entry.data.tags && entry.data.tags.length > 0 && (
      <div class="flex flex-wrap items-center gap-1.5 pt-1">
        {entry.data.tags.slice(0, 3).map((tag) => {
          const { className, tooltip } = getTagVariant(tag)
          return (
            <div class="group/tag relative">
              <span
                class={`inline-flex items-center gap-1 rounded-full border border-white/60 bg-white/70 px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-slate-600 transition-colors group-hover/tag:text-slate-900 dark:border-white/10 dark:bg-white/10 dark:text-emerald-100 ${className || ''}`}
              >
                #{tag}
              </span>
              {tooltip && (
                <span class="pointer-events-none absolute left-1/2 bottom-full z-[100] mb-2 w-max max-w-xs -translate-x-1/2 rounded-md border border-gray-700 bg-gray-900 px-2 py-1 text-[10px] text-white opacity-0 shadow-xl transition-all duration-200 group-hover/tag:opacity-100 dark:border-gray-200 dark:bg-gray-50 dark:text-gray-900">
                  {tooltip}
                  <span class="absolute left-1/2 top-full h-0 w-0 -translate-x-1/2 border-l-[4px] border-r-[4px] border-t-[4px] border-l-transparent border-r-transparent border-t-gray-900 dark:border-t-gray-50"></span>
                </span>
              )}
            </div>
          )
        })}
        {
          entry.data.tags.length > 3 && (
            <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">
              +{entry.data.tags.length - 3}
            </span>
          )
        }
      </div>
    )
  }
</Link>
